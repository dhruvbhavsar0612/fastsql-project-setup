"""SMTP Email service for sending notifications."""

import asyncio
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from typing import Any

import aiosmtplib
from pydantic import BaseModel, EmailStr

from ..config import settings


class EmailMessage(BaseModel):
    """Email message schema."""

    to: list[EmailStr]
    subject: str
    body_text: str | None = None
    body_html: str | None = None
    cc: list[EmailStr] | None = None
    bcc: list[EmailStr] | None = None
    reply_to: EmailStr | None = None


class EmailService:
    """Service for sending emails via SMTP."""

    def __init__(self):
        self.host = settings.smtp_host
        self.port = settings.smtp_port
        self.username = settings.smtp_username
        self.password = settings.smtp_password
        self.sender_email = settings.smtp_sender_email
        self.sender_name = settings.smtp_sender_name
        self.use_tls = settings.smtp_use_tls

    async def send_email(self, message: EmailMessage) -> dict[str, Any]:
        """
        Send an email via SMTP.

        Args:
            message: EmailMessage with recipients and content

        Returns:
            Dict with send status and message_id
        """
        msg = MIMEMultipart("alternative")
        msg["Subject"] = message.subject
        msg["From"] = f"{self.sender_name} <{self.sender_email}>"
        msg["To"] = ", ".join(message.to)

        if message.cc:
            msg["Cc"] = ", ".join(message.cc)
        if message.reply_to:
            msg["Reply-To"] = message.reply_to

        # Add text and HTML parts
        if message.body_text:
            msg.attach(MIMEText(message.body_text, "plain", "utf-8"))
        if message.body_html:
            msg.attach(MIMEText(message.body_html, "html", "utf-8"))

        # Collect all recipients
        all_recipients = list(message.to)
        if message.cc:
            all_recipients.extend(message.cc)
        if message.bcc:
            all_recipients.extend(message.bcc)

        try:
            async with aiosmtplib.SMTP(
                hostname=self.host,
                port=self.port,
                use_tls=self.use_tls,
            ) as smtp:
                if self.username and self.password:
                    await smtp.login(self.username, self.password)

                response = await smtp.send_message(msg, recipients=all_recipients)

            return {
                "success": True,
                "message_id": msg["Message-ID"],
                "recipients": all_recipients,
                "response": str(response),
            }

        except aiosmtplib.SMTPException as e:
            return {
                "success": False,
                "error": str(e),
                "recipients": all_recipients,
            }

    async def send_email_batch(
        self,
        messages: list[EmailMessage],
        delay: float = 0.1,
    ) -> list[dict[str, Any]]:
        """
        Send multiple emails with optional delay between sends.

        Args:
            messages: List of EmailMessage objects
            delay: Delay in seconds between sends (rate limiting)

        Returns:
            List of send results
        """
        results = []
        for message in messages:
            result = await self.send_email(message)
            results.append(result)
            if delay > 0:
                await asyncio.sleep(delay)
        return results

    async def send_welcome_email(self, to_email: str, username: str) -> dict[str, Any]:
        """Send a welcome email to new users."""
        message = EmailMessage(
            to=[to_email],
            subject=f"Welcome to {settings.app_name}!",
            body_text=f"Hello {username},\n\nWelcome to {settings.app_name}! We're excited to have you on board.\n\nBest regards,\nThe {settings.app_name} Team",
            body_html=f"""
            <html>
            <body>
                <h1>Welcome to {settings.app_name}!</h1>
                <p>Hello {username},</p>
                <p>We're excited to have you on board.</p>
                <p>Best regards,<br>The {settings.app_name} Team</p>
            </body>
            </html>
            """,
        )
        return await self.send_email(message)

    async def send_password_reset_email(
        self, to_email: str, reset_token: str
    ) -> dict[str, Any]:
        """Send a password reset email."""
        reset_url = f"{settings.frontend_url}/reset-password?token={reset_token}"
        message = EmailMessage(
            to=[to_email],
            subject=f"Password Reset - {settings.app_name}",
            body_text=f"Click the following link to reset your password:\n\n{reset_url}\n\nThis link will expire in 1 hour.",
            body_html=f"""
            <html>
            <body>
                <h1>Password Reset</h1>
                <p>Click the button below to reset your password:</p>
                <p><a href="{reset_url}" style="background-color: #4CAF50; color: white; padding: 14px 25px; text-decoration: none; display: inline-block;">Reset Password</a></p>
                <p>This link will expire in 1 hour.</p>
                <p>If you didn't request this, please ignore this email.</p>
            </body>
            </html>
            """,
        )
        return await self.send_email(message)


# Default email service instance
email_service = EmailService()
